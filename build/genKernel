#!/bin/bash

# Author: Pramuka Perera
# Last Major Update: 2 Feburary 2020
# Description:  Scrape data necessary to load kernel into memory
#               Requires files generated by 'make dump'

# Get size and start address of each location
echo "Hex Size:"
TEXT_SIZE=$(grep "0\s.text\s" kernel.info | cut -d " " -f 13 | awk '{ print toupper($0)}')
RODATA_SIZE=$(grep "1\s.rodata\s" kernel.info | cut -d " " -f 11 | awk '{ print toupper($0)}')
GOT_SIZE=$(grep "2\s.got\s" kernel.info | cut -d " " -f 14 | awk '{ print toupper($0)}')
BSS_SIZE=$(grep "3\s.bss\s" kernel.info | cut -d " " -f 14 | awk '{ print toupper($0)}')

echo $TEXT_SIZE
echo $RODATA_SIZE
echo $GOT_SIZE
echo $BSS_SIZE
echo ""

echo "Decimal Size:"
TEXT_SIZE_DEC=$(echo "obase=10;ibase=16;$TEXT_SIZE"| bc)
RODATA_SIZE_DEC=$(echo "obase=10;ibase=16;$RODATA_SIZE"| bc)
GOT_SIZE_DEC=$(echo "obase=10;ibase=16;$GOT_SIZE"| bc)
BSS_SIZE_DEC=$(echo "obase=10;ibase=16;$BSS_SIZE"| bc)

echo $TEXT_SIZE_DEC
echo $RODATA_SIZE_DEC
echo $GOT_SIZE_DEC
echo $BSS_SIZE_DEC
echo ""

echo "Hex Start Addresses:"
TEXT_ADDR=$(grep "0\s.text\s" kernel.info | cut -d " " -f 15 | awk '{ print toupper($0)}')
RODATA_ADDR=$(grep "1\s.rodata\s" kernel.info | cut -d " " -f 13 | awk '{ print toupper($0)}')
GOT_ADDR=$(grep "2\s.got\s" kernel.info | cut -d " " -f 16 | awk '{ print toupper($0)}')
BSS_ADDR=$(grep "3\s.bss\s" kernel.info | cut -d " " -f 16 | awk '{ print toupper($0)}')

echo $TEXT_ADDR
echo $RODATA_ADDR
echo $GOT_ADDR
echo $BSS_ADDR
echo ""

echo "Decimal Start Addresses:"
TEXT_ADDR_DEC=$(echo "obase=10;ibase=16;$TEXT_ADDR"| bc)
RODATA_ADDR_DEC=$(echo "obase=10;ibase=16;$RODATA_ADDR"| bc)
GOT_ADDR_DEC=$(echo "obase=10;ibase=16;$GOT_ADDR"| bc)
BSS_ADDR_DEC=$(echo "obase=10;ibase=16;$BSS_ADDR"| bc)

echo $TEXT_ADDR_DEC
echo $RODATA_ADDR_DEC
echo $GOT_ADDR_DEC
echo $BSS_ADDR_DEC
echo ""

# Write section size and start address to image
echo "text $TEXT_SIZE_DEC $TEXT_ADDR_DEC" | tee kernel.ser
echo "rodata $RODATA_SIZE_DEC $RODATA_ADDR_DEC" | tee -a kernel.ser
echo "got $GOT_SIZE_DEC $GOT_ADDR_DEC" | tee -a kernel.ser
echo "bss $BSS_SIZE_DEC $BSS_ADDR_DEC" | tee -a kernel.ser
echo ""

echo "" | tee -a kernel.ser

# grab address and data of .text, .rodata, and .got and write it into image
cat kernel.dump | 
sed -e '/.*comment.*/q' | 
sed -e 's/.*elf32.*//' | 
sed -e 's/.*Contents.*//' | 
sed -e 's/^$//' | 
sed -e '/^$/d' | 
sed -e 's/^ //' | 
cut -d " " -f 1-6 | 
tee -a kernel.ser

